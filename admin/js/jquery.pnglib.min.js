/**
* A handy class to calculate color values.
*
* @version 1.0
* @author Robert Eisele <robert@xarg.org>
* @copyright Copyright (c) 2010, Robert Eisele
* @link http://www.xarg.org/2010/03/generate-client-side-png-files-using-javascript/
* @license http://www.opensource.org/licenses/bsd-license.php BSD License
*
*/

!function(){function a(a,b){for(var c=2;c<arguments.length;c++)for(var d=0;d<arguments[c].length;d++)a[b++]=arguments[c].charAt(d)}function b(a){return String.fromCharCode(255&a>>8,255&a)}function c(a){return String.fromCharCode(255&a>>24,255&a>>16,255&a>>8,255&a)}function d(a){return String.fromCharCode(255&a,255&a>>8)}window.PNGlib=function(e,f,g){this.width=e,this.height=f,this.depth=g,this.pix_size=f*(e+1),this.data_size=2+this.pix_size+5*Math.floor((65534+this.pix_size)/65535)+4,this.ihdr_offs=0,this.ihdr_size=25,this.plte_offs=this.ihdr_offs+this.ihdr_size,this.plte_size=8+3*g+4,this.trns_offs=this.plte_offs+this.plte_size,this.trns_size=8+g+4,this.idat_offs=this.trns_offs+this.trns_size,this.idat_size=8+this.data_size+4,this.iend_offs=this.idat_offs+this.idat_size,this.iend_size=12,this.buffer_size=this.iend_offs+this.iend_size,this.buffer=new Array,this.palette=new Object,this.pindex=0;for(var h=new Array,i=0;i<this.buffer_size;i++)this.buffer[i]="\0";a(this.buffer,this.ihdr_offs,c(this.ihdr_size-12),"IHDR",c(e),c(f),"\b"),a(this.buffer,this.plte_offs,c(this.plte_size-12),"PLTE"),a(this.buffer,this.trns_offs,c(this.trns_size-12),"tRNS"),a(this.buffer,this.idat_offs,c(this.idat_size-12),"IDAT"),a(this.buffer,this.iend_offs,c(this.iend_size-12),"IEND");var j=30912;j+=31-j%31,a(this.buffer,this.idat_offs+8,b(j));for(var i=0;(i<<16)-1<this.pix_size;i++){var k,l;i+65535<this.pix_size?(k=65535,l="\0"):(k=this.pix_size-(i<<16)-i,l=""),a(this.buffer,this.idat_offs+8+2+(i<<16)+(i<<2),l,d(k),d(~k))}for(var i=0;256>i;i++){for(var m=i,n=0;8>n;n++)m=1&m?-306674912^2147483647&m>>1:2147483647&m>>1;h[i]=m}this.index=function(a,b){var c=b*(this.width+1)+a+1,d=this.idat_offs+8+2+5*Math.floor(c/65535+1)+c;return d},this.color=function(a,b,c,d){d=d>=0?d:255;var e=((d<<8|a)<<8|b)<<8|c;if("undefined"==typeof this.palette[e]){if(this.pindex==this.depth)return"\0";var f=this.plte_offs+8+3*this.pindex;this.buffer[f+0]=String.fromCharCode(a),this.buffer[f+1]=String.fromCharCode(b),this.buffer[f+2]=String.fromCharCode(c),this.buffer[this.trns_offs+8+this.pindex]=String.fromCharCode(d),this.palette[e]=String.fromCharCode(this.pindex++)}return this.palette[e]},this.getBase64=function(){var c,d,e,f,g,h,i,a=this.getDump(),b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",j=a.length,k=0,l="";do c=a.charCodeAt(k),f=c>>2,d=a.charCodeAt(k+1),g=(3&c)<<4|d>>4,e=a.charCodeAt(k+2),h=k+2>j?64:(15&d)<<2|e>>6,i=k+3>j?64:63&e,l+=b.charAt(f)+b.charAt(g)+b.charAt(h)+b.charAt(i);while((k+=3)<j);return l},this.getDump=function(){function k(b,d,e){for(var f=-1,g=4;e-4>g;g+=1)f=h[255&(f^b[d+g].charCodeAt(0))]^16777215&f>>8;a(b,d+e-4,c(-1^f))}for(var b=65521,d=5552,e=1,f=0,g=d,i=0;i<this.height;i++)for(var j=-1;j<this.width;j++)e+=this.buffer[this.index(j,i)].charCodeAt(0),f+=e,0==(g-=1)&&(e%=b,f%=b,g=d);return e%=b,f%=b,a(this.buffer,this.idat_offs+this.idat_size-8,c(f<<16|e)),k(this.buffer,this.ihdr_offs,this.ihdr_size),k(this.buffer,this.plte_offs,this.plte_size),k(this.buffer,this.trns_offs,this.trns_size),k(this.buffer,this.idat_offs,this.idat_size),k(this.buffer,this.iend_offs,this.iend_size),"\x89PNG\r\n\n"+this.buffer.join("")}}}();